<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NL-2-SQL</title>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-shape">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                </div>
                <div>
                    <h1>NL-2-SQL</h1>
                    <p>Transform questions into queries</p>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tabs">
            <button class="tab active" data-tab="schema">
                <span class="tab-num">1</span>
                <span class="tab-label">Database Schema</span>
            </button>
            <button class="tab" data-tab="question">
                <span class="tab-num">2</span>
                <span class="tab-label">Your Question</span>
            </button>
            <button class="tab" data-tab="result">
                <span class="tab-num">3</span>
                <span class="tab-label">SQL Result</span>
            </button>
        </nav>

        <!-- Tab Panels -->
        <div class="panels">
            <!-- Schema Panel -->
            <section class="panel active" id="schema-panel">
                <div class="panel-inner">
                    <div class="panel-title">
                        <h2>Define Your Database</h2>
                        <p>Paste CREATE TABLE statements to describe your schema</p>
                    </div>
                    <div class="editor-box">
                        <textarea id="schema-input" spellcheck="false">


CREATE TABLE PlaylistTrack (
    PlaylistId INTEGER NOT NULL,
    TrackId INTEGER NOT NULL,
    PRIMARY KEY (PlaylistId, TrackId),
    FOREIGN KEY (PlaylistId) REFERENCES Playlist(PlaylistId),
    FOREIGN KEY (TrackId) REFERENCES Track(TrackId)
);

CREATE TABLE Playlist (
    PlaylistId INTEGER PRIMARY KEY,
    Name NVARCHAR(120)
);

CREATE TABLE InvoiceLine (
    InvoiceLineId INTEGER PRIMARY KEY,
    InvoiceId INTEGER NOT NULL,
    TrackId INTEGER NOT NULL,
    UnitPrice NUMERIC(10,2) NOT NULL,
    Quantity INTEGER NOT NULL,
    FOREIGN KEY (InvoiceId) REFERENCES Invoice(InvoiceId),
    FOREIGN KEY (TrackId) REFERENCES Track(TrackId)
);

CREATE TABLE Invoice (
    InvoiceId INTEGER PRIMARY KEY,
    CustomerId INTEGER NOT NULL,
    InvoiceDate DATETIME NOT NULL,
    BillingAddress NVARCHAR(70),
    BillingCity NVARCHAR(40),
    BillingState NVARCHAR(40),
    BillingCountry NVARCHAR(40),
    BillingPostalCode NVARCHAR(10),
    Total NUMERIC(10,2) NOT NULL,
    FOREIGN KEY (CustomerId) REFERENCES Customer(CustomerId)
);

CREATE TABLE Employee (
    EmployeeId INTEGER PRIMARY KEY,
    LastName NVARCHAR(20) NOT NULL,
    FirstName NVARCHAR(20) NOT NULL,
    Title NVARCHAR(30),
    ReportsTo INTEGER,
    BirthDate DATETIME,
    HireDate DATETIME,
    Address NVARCHAR(70),
    City NVARCHAR(40),
    State NVARCHAR(40),
    Country NVARCHAR(40),
    PostalCode NVARCHAR(10),
    Phone NVARCHAR(24),
    Fax NVARCHAR(24),
    Email NVARCHAR(60),
    FOREIGN KEY (ReportsTo) REFERENCES Employee(EmployeeId)
);

CREATE TABLE Customer (
    CustomerId INTEGER PRIMARY KEY,
    FirstName NVARCHAR(40) NOT NULL,
    LastName NVARCHAR(20) NOT NULL,
    Company NVARCHAR(80),
    Address NVARCHAR(70),
    City NVARCHAR(40),
    State NVARCHAR(40),
    Country NVARCHAR(40),
    PostalCode NVARCHAR(10),
    Phone NVARCHAR(24),
    Fax NVARCHAR(24),
    Email NVARCHAR(60) NOT NULL,
    SupportRepId INTEGER,
    FOREIGN KEY (SupportRepId) REFERENCES Employee(EmployeeId)
);

CREATE TABLE Track (
    TrackId INTEGER PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL,
    AlbumId INTEGER,
    MediaTypeId INTEGER NOT NULL,
    GenreId INTEGER,
    Composer NVARCHAR(220),
    Milliseconds INTEGER NOT NULL,
    Bytes INTEGER,
    UnitPrice NUMERIC(10,2) NOT NULL,
    FOREIGN KEY (AlbumId) REFERENCES Album(AlbumId),
    FOREIGN KEY (MediaTypeId) REFERENCES MediaType(MediaTypeId),
    FOREIGN KEY (GenreId) REFERENCES Genre(GenreId)
);

CREATE TABLE MediaType (
    MediaTypeId INTEGER PRIMARY KEY,
    Name NVARCHAR(120)
);

CREATE TABLE MediaType (
    MediaTypeId INTEGER PRIMARY KEY,
    Name NVARCHAR(120)
);

CREATE TABLE Genre (
    GenreId INTEGER PRIMARY KEY,
    Name NVARCHAR(120)
);

CREATE TABLE Album (
    AlbumId INTEGER PRIMARY KEY,
    Title NVARCHAR(160) NOT NULL,
    ArtistId INTEGER,
    FOREIGN KEY (ArtistId) REFERENCES Artist(ArtistId)
);

CREATE TABLE Artist (
    ArtistId INTEGER PRIMARY KEY,
    Name NVARCHAR(120)
);

</textarea>
                    </div>
                    <button class="btn-next" onclick="showTab('question')">
                        Continue to Question ‚Üí
                    </button>
                </div>
            </section>

            <!-- Question Panel -->
            <section class="panel" id="question-panel">
                <div class="panel-inner">
                    <div class="panel-title">
                        <h2>Ask Your Question</h2>
                        <p>Describe what data you want in plain English</p>
                    </div>
                    <div class="question-box">
                        <textarea id="question-input"
                            placeholder="Example: Find all customers who ordered more than $500 worth of products last month"></textarea>
                    </div>
                    <div class="quick-examples">
                        <span>Quick examples:</span>
                        <button onclick="fillExample('Show total sales by product category')">Sales by category</button>
                        <button onclick="fillExample('List customers who have not placed any orders')">Inactive
                            customers</button>
                        <button onclick="fillExample('Top 10 customers by total spending')">Top customers</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn-back" onclick="showTab('schema')">‚Üê Back</button>
                        <button class="btn-generate" onclick="generateSQL()" id="generate-btn">
                            <span class="btn-text">Generate SQL</span>
                            <span class="btn-loader">
                                <span class="dot-loader"></span>
                                Generating...
                            </span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Result Panel -->
            <section class="panel" id="result-panel">
                <div class="panel-inner">
                    <div class="panel-title">
                        <h2>Your SQL Query</h2>
                        <p>Generated with step-by-step reasoning</p>
                    </div>

                    <div id="results-container">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <p>Enter a schema and question to generate SQL</p>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn-back" onclick="showTab('question')">‚Üê New Question</button>
                        <button class="btn-copy" onclick="copySQL()" id="copy-btn" style="display:none;">üìã Copy
                            SQL</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <footer>
            <p></p>
        </footer>
    </div>

    <script>
        // Tab switching
        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${name}"]`).classList.add('active');
            document.getElementById(`${name}-panel`).classList.add('active');
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => showTab(tab.dataset.tab));
        });

        function fillExample(text) {
            document.getElementById('question-input').value = text;
        }

        async function generateSQL() {
            const schema = document.getElementById('schema-input').value.trim();
            const question = document.getElementById('question-input').value.trim();

            if (!schema) { alert('Please enter a database schema'); showTab('schema'); return; }
            if (!question) { alert('Please enter a question'); return; }

            const btn = document.getElementById('generate-btn');
            btn.classList.add('loading');
            btn.disabled = true;

            showTab('result');
            document.getElementById('results-container').innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Analyzing your question...</p>
                    <span>This may take 10-30 seconds</span>
                </div>
            `;

            try {
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema, question })
                });
                const data = await res.json();

                if (data.success) {
                    displayResults(data);
                } else {
                    showError(data.error, data.security_blocked);
                }
            } catch (e) {
                showError('Connection failed: ' + e.message, false);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        function displayResults(data) {
            const steps = parseSteps(data.reasoning);

            document.getElementById('results-container').innerHTML = `
                ${data.answer ? `
                <div class="result-answer">
                    <div class="result-header">In Plain English</div>
                    <div class="answer-text">${escapeHtml(data.answer)}</div>
                </div>
                ` : ''}
                
                <div class="result-sql">
                    <div class="result-header">
                        <span>Generated SQL</span>
                        ${data.verification?.is_valid ? '<span class="badge success">‚úì Valid</span>' : ''}
                    </div>
                    <pre><code id="sql-code">${escapeHtml(data.sql)}</code></pre>
                </div>
                
                <div class="result-flow">
                    <div class="result-header">How I figured it out</div>
                    <div class="flow-steps">
                        ${steps.map((step, i) => `
                            <div class="flow-step">
                                <div class="step-marker">${i + 1}</div>
                                <div class="step-text">${escapeHtml(step)}</div>
                            </div>
                            ${i < steps.length - 1 ? '<div class="step-arrow">‚Üì</div>' : ''}
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('copy-btn').style.display = 'inline-flex';
        }

        function showError(msg, isSecurityBlock = false) {
            const title = isSecurityBlock ? 'Request Blocked' : 'Something went wrong';
            document.getElementById('results-container').innerHTML = `
                <div class="error-state ${isSecurityBlock ? 'security-block' : ''}">
                    <div class="error-icon"></div>
                    <h3>${title}</h3>
                    <p>${escapeHtml(msg)}</p>
                    ${!isSecurityBlock ? '<button class="btn-retry" onclick="generateSQL()" style="margin-top: 20px;">üîÑ Retry</button>' : '<button class="btn-retry" onclick="showTab(\'question\')" style="margin-top: 20px;">‚Üê Modify Question</button>'}
                </div>
            `;
            document.getElementById('copy-btn').style.display = 'none';
        }

        function parseSteps(text) {
            return text.split('\n')
                .map(l => l.replace(/^\d+[\.\)]\s*/, '').replace(/^[-‚Ä¢*]\s*/, '').trim())
                .filter(l => l.length > 5)
                .slice(0, 6);
        }

        function escapeHtml(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        function copySQL() {
            const sql = document.getElementById('sql-code').textContent;
            navigator.clipboard.writeText(sql);
            const btn = document.getElementById('copy-btn');
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy SQL', 2000);
        }
    </script>
</body>

</html>